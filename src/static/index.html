<!DOCTYPE html>
<html>

<head>
  <title>Ponk</title>
  <style>
    body {
      font-family: sans-serif;
    }

    .qr a {
      display: block;
    }

    .qr a,
    .svg {
      width: fit-content;
    }

    #canvas {
      display: none;
      border: 1px solid grey;
      border-width: 0 1px;
      background-color: cyan;
    }
  </style>
</head>

<body>
  <div id="lobby">
    <h1>Ponk!</h1>

    <div id="player1">
      <div class="qr">
        <p>Scan QR code to connect</p>
        <a href="/1" target="_blank">
          <div class="svg"></div>
        </a>
      </div>
      <pre class="output"></pre>
    </div>

    <div id="player2">
      <div class="qr">
        <p>Scan QR code to connect</p>
        <a href="/2" target="_blank">
          <div class="svg"></div>
        </a>
      </div>
      <pre class="output"></pre>
    </div>
  </div>

  <canvas id="canvas" width="800" height="800">Game area</canvas>

  <div id="puck">
    <pre class="output"></pre>
  </div>

  <script src="/js/qrcode.min.js"></script>
  <script>
    [1, 2].forEach((i) => {
      var qrcode = new QRCode({
        content: new URL(i, window.location.href).toString(),
        container: "svg", //Responsive use
        join: true //Crisp rendering and 4-5x reduced file size
      });
      var svg = qrcode.svg();
      document.querySelector(`#player${i} .svg`).innerHTML = svg;
    });
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io({ query: { role: 'display', width: 800, height: 800 } });

    let numberSprites = null;
    (function () {
      const img = new Image();
      img.onload = () => numberSprites = img;
      img.src = '/img/numbers.png';
    })();

    let canvas = null;
    let gameState = null;
    let score = null;

    function drawGameState() {
      canvas.clearRect(0, 0, 800, 800);

      if (score && numberSprites) {
        canvas.drawImage(numberSprites, score.p1 * 5, 0, 5, 5, 375, 200, 50, 50);
        canvas.drawImage(numberSprites, score.p2 * 5, 0, 5, 5, 375, 600, 50, 50);
      }

      canvas.fillStyle = 'black';

      canvas.fillRect(gameState.puck.x, gameState.puck.y, 10, 10);
      canvas.fillRect(gameState.p1, 5, 100, 15);
      canvas.fillRect(gameState.p2, 780, 100, 15);

      window.requestAnimationFrame(drawGameState);
    }

    socket.on('game', (game, ack) => {
      //console.log(game);
      gameState = game;

      if (!canvas) {
        document.querySelector('#lobby').style.display = 'none';

        const canvasElement = document.getElementById('canvas');
        canvasElement.style.display = 'block';

        canvas = canvasElement.getContext('2d');
        canvas.imageSmoothingEnabled = false;

        window.requestAnimationFrame(drawGameState);
      }

      document.querySelector('#player1 .output').textContent = score?.p1;
      document.querySelector('#player2 .output').textContent = score?.p2;
      document.querySelector('#puck .output').textContent = `(${game.puck.x | 0}, ${game.puck.y | 0})`;

      ack?.call(null, "ack");
    });

    socket.on('score', s => score = s);
  </script>
</body>

</html>
