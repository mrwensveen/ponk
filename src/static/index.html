<!DOCTYPE html>
<html>

<head>
  <title>Ponk</title>
  <style>
    body {
      font-family: sans-serif;
    }

    .qr a {
      display: block;
    }

    .qr a,
    .svg {
      width: fit-content;
    }

    #canvas {
      display: none;
      border: 1px solid grey;
    }
  </style>
</head>

<body>
  <h1>Ponk!</h1>

  <canvas id="canvas" width="800" height="800">Game area</canvas>

  <div id="player1">
    <div class="qr">
      <p>Scan QR code to connect</p>
      <a href="/1" target="_blank">
        <div class="svg"></div>
      </a>
    </div>
    <pre class="output"></pre>
  </div>

  <div id="player2">
    <div class="qr">
      <p>Scan QR code to connect</p>
      <a href="/2" target="_blank">
        <div class="svg"></div>
      </a>
    </div>
    <pre class="output"></pre>
  </div>

  <div id="puck">
    <pre class="output"></pre>
  </div>

  <script src="/js/qrcode.min.js"></script>
  <script>
    [1, 2].forEach((i) => {
      var qrcode = new QRCode({
        content: new URL(i, window.location.href).toString(),
        container: "svg", //Responsive use
        join: true //Crisp rendering and 4-5x reduced file size
      });
      var svg = qrcode.svg();
      document.querySelector(`#player${i} .svg`).innerHTML = svg;
    });
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io({ query: { role: 'display', width: 800, height: 800 } });

    let canvas = null;
    let gameState = null;

    function drawGameState() {
      canvas.clearRect(0, 0, 800, 800);
      canvas.fillStyle = 'black';

      canvas.fillRect(gameState.puck.x, gameState.puck.y, 10, 10);
      canvas.fillRect(gameState.p1 / 180 * 700, 0, 100, 15);
      canvas.fillRect(gameState.p2 / 180 * 700, 785, 100, 15);

      window.requestAnimationFrame(drawGameState);
    }

    socket.on('game', (game, ack) => {
      gameState = game;

      if (!canvas) {
        document.querySelector('#player1 .qr').style.display = 'none';
        document.querySelector('#player2 .qr').style.display = 'none';

        const canvasElement = document.getElementById('canvas');
        canvasElement.style.display = 'block';

        canvas = canvasElement.getContext('2d');

        window.requestAnimationFrame(drawGameState);
      }

      // TODO: Show the puck and paddles visually
      document.querySelector('#player1 .output').textContent = game.p1;
      document.querySelector('#player2 .output').textContent = game.p2;
      document.querySelector('#puck .output').textContent = `(${game.puck.x | 0}, ${game.puck.y | 0})`;

      ack?.call(null, "hey");
    });
  </script>
</body>

</html>
